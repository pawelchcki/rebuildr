name: Release
on:
  push:
    tags:
      - 'v*'
jobs:
  # Build and test before release
  pre-release:
    name: Pre-release Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@786fff0690178f1234e4e1fe9b536e94f5433196 # v20
      - name: Run all checks
        run: |
          nix fmt
          if ! git diff --quiet; then
            echo "âŒ Code formatting issues found. Please run 'nix fmt' to fix them."
            git diff
            exit 1
          fi
          nix flake check
  # Build and publish dist image with tag
  build-and-publish-dist:
    name: Build & Publish Dist Image
    runs-on: ubuntu-latest
    needs: pre-release
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@786fff0690178f1234e4e1fe9b536e94f5433196 # v20
      - name: Set up QEMU
        uses: docker/setup-qemu-action@29109295f81e9208d7d86ff1c6c12d2833863392 # v3.6.0
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1
      - name: Login to ghcr.io
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: echo "$GH_TOKEN" | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin
      - name: Get tag name
        id: get_tag
        run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      - name: Build and push dist image with tag
        env:
          REBUILDR_DIST_REPOSITORY: ghcr.io/${{ github.repository_owner }}/rebuildr/dist
          REBUILDR_DIST_TAG: ${{ steps.get_tag.outputs.TAG_NAME }}
        run: |
          # Build and push with the version tag
          nix run .#rebuildr -- load-py ci/dist/dist.rebuildr.py push-image
